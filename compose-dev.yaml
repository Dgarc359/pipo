services:
  irc:
    image: lscr.io/linuxserver/ngircd:latest
    container_name: irc
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Etc/utc
    volumes:
      - ./dev-environment/irc:/config
    ports:
      - "${IRCD_LISTEN_ADDR:-127.0.0.1}:${IRCD_PORT:-6667}:6667"
      - "${IRCD_LISTEN_ADDR:-127.0.0.1}:${IRCD_TLS_PORT:-6697}:6697"
    restart: unless-stopped
      #build:
      #context: ./dev-environment/unrealircd
      #    restart: unless-stopped
      #    configs:
      #      - source: unrealircd
      #        target: /ircd/unrealircd.conf
      #    ports:
      #      - "${IRCD_LISTEN_ADDR:-127.0.0.1}:${IRCD_PORT:-6667}:6667"
      #      - "${IRCD_LISTEN_ADDR:-127.0.0.1}:${IRCD_TLS_PORT:-6697}:6697"
    healthcheck:
      test: ["CMD", "netstat", "-an", "|", "grep", "6697", "/dev/null;", "if", "[", "0", "!=", "$?", "];", "then", "exit", "1;", "fi;"]
      interval: 1s
      timeout: 60s
      retries: 60

  postgres:
    image: postgres
    restart: always
    shm_size: 128mb
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust

  postgres-init:
    depends_on:
      - postgres
    build:
      context: ./dev-environment/postgres-init

  synapse:
    depends_on:
      - app
    image: matrixdotorg/synapse
    environment:
      UID: 0
      GID: 0
    ports:
      - 8001:8008
    configs:
      - source: synapse
        target: /data/homeserver.yaml
      - source: synapse-log-config
        target: /data/synapse.log.config
    volumes:
      - type: volume
        source: as-registry
        target: /data/appservices
      - type: volume
        source: synapse-data
        target: /data

  app:
    links:
      - irc
    depends_on:
      irc:
        condition: service_healthy
    build:
      context: .
      target: debug
    ports:
      - 8002:3000
    configs:
      - source: pipo
        target: /etc/pipo.json
    volumes:
      - type: volume
        source: db-data
        target: /var/lib/pipo
      - type: volume
        source: as-registry
        target: /etc/matrix-synapse/appservices
    command:  [ "pipo", "/etc/pipo.json", "/var/lib/pipo/db.sqlite3"]

configs:
  pipo:
    file: ./dev-environment/pipo/config.json
  synapse:
    file: ./dev-environment/synapse/homeserver.yaml
  unrealircd:
    file: ./dev-environment/unrealircd/unrealircd.conf
  irc:
    file: ./dev-environment/irc/irc.conf
  synapse-log-config:
    file: ./dev-environment/synapse/synapse.log.config

volumes:
  db-data:
  as-registry:
  synapse-data:
